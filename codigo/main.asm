.INCLUDE 	"M328PDEF.INC"

.CSEG

.ORG 	0x00
	RJMP	MAIN
.ORG ICP1addr
	JMP ISR_ICP1

.ORG OVF1addr
	JMP RESTART_TIMER
.ORG 	0x24
	RJMP 	HC05_RECEPTION_HANDLER


.ORG 	INT_VECTORS_SIZE

MAIN:
	LDI 	TEMP, LOW(RAMEND)
	OUT		SPL, TEMP
	LDI 	TEMP, HIGH(RAMEND)
	OUT 	SPH, TEMP
	
	SBI DDRB,5	
	SBI PORTB,5	
	
	RCALL	INIC_ANGULOS	;INICIALIZA VALORES DE ANGULOS DE LOS SERVOS		
	RCALL	MOVEMENT_SETUP	;SERVOS EN POSICIÓN INICIAL		
	RCALL 	HC05_SETUP
	RCALL	HC_SR04_SETUP ; configuro el trigger y configuro el timer/wave generator

	
	
MAIN_LOOP:
	RCALL 	MOVEMENT_SWITCH
	BRTS	TURN_ON
	BRTC	TURN_OFF
	RJMP 	MAIN_LOOP

TURN_ON:
	SBI PORTB,5
	RET


TURN_OFF:
	CBI PORTB,5
	RET

;error
ERRLOOP:
	RJMP	ERRLOOP


DELAY_10_S:
	PUSH	R25
	LDI		R25,50
LOOP_DELAY_1_S:
	RCALL	DELAY_100_MS
	DEC	R25
	brne LOOP_DELAY_1_S
	
	POP		R25
	RET

DELAY_100_MS:	;DELAY DE 100 MILISEGUNDOS PARA UN CLOCK DE 1MZ
	push r22
	push r24
	ldi r22, 200 ;
LOOP_DELAY_1:
	ldi R24, 170
LOOP_DELAY_2:
	DEC	R24
	brne LOOP_DELAY_2
	dec r22
	brne LOOP_DELAY_1

	pop r24
	pop r22
	ret


.INCLUDE	"DEFINES.INC"
.INCLUDE	"ANGULOS.INC"
.INCLUDE 	"MOVEMENT.INC"
.INCLUDE 	"HCSR04.INC"
.INCLUDE 	"HC05.INC"
