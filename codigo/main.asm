.INCLUDE 	"M328PDEF.INC"



.CSEG


.ORG 	0x00
	RJMP	MAIN
.ORG 	0x02
	RJMP 	EXT_INT0
.ORG 	0x1E
	RJMP	TIM1_OVF
;INTERRUPCIONES







.ORG 	INT_VECTORS_SIZE
MAIN:
INIC_SP:
	ldi r16,low(RAMEND)
	out spl,r16
	ldi r16,high(RAMEND)
	out sph,r16
	

	SBI DDRB,5

	RCALL	INIC_ANGULOS	;INICIALIZA VALORES DE ANGULOS DE LOS SERVOS	

	RCALL	MOVEMENT_SETUP	;SERVOS EN POSICIÓN INICIAL
	RCALL	MOVEMENT_DELAY


;	RCALL 	HCSR04_SETUP
;	CLR 	R21
;	CLR		R22
	

;	RCALL STAND_GREET_LEFT ;SALUDA
;	RCALL MOVEMENT_DELAY

MAIN_LOOP:
	LDI		LEG_L,LOW(LEG_3)
	LDI		LEG_H,HIGH(LEG_3)

;	MOV		R23,LEG_H
;	LDI 	R24,LOW(1100)
;	LDI 	R25,HIGH(1100)
;	RCALL 	PCA9685_MOVE


;	RCALL	ROLL_LEG_TEST
;	RCALL	YAW_LEG_TEST
;	RCALL TURN_RIGHT
;	RCALL MOVEMENT_DELAY

	RCALL TURN_LEFT
;	RCALL MOVEMENT_DELAY



	RJMP 	MAIN_LOOP

TURN_ON:
	SBI PORTB,5
	RET


TURN_OFF:
	CBI PORTB,5
	RET



;error
ERRLOOP:
	RJMP	ERRLOOP

DELAY_10_S:
	PUSH	R25
	LDI		R25,50
LOOP_DELAY_1_S:
	RCALL	DELAY_100_MS
	DEC	R25
	brne LOOP_DELAY_1_S
	
	POP		R25
	RET

DELAY_100_MS:	;DELAY DE 100 MILISEGUNDOS PARA UN CLOCK DE 1MZ
	push r22
	push r24
	ldi r22, 200 ;
LOOP_DELAY_1:
	ldi R24, 170
LOOP_DELAY_2:
	DEC	R24
	brne LOOP_DELAY_2
	dec r22
	brne LOOP_DELAY_1

	pop r24
	pop r22
	ret


.INCLUDE	"DEFINES.INC"
.INCLUDE	"ANGULOS.INC"
.INCLUDE 	"MOVEMENT.INC"
.INCLUDE 	"HCSR04.INC"
